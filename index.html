import React, { useState, useEffect, useMemo } from 'react';
import { Trash2, ArrowDownUp, Info, Lightbulb, CheckCircle2, Trophy, AlertCircle } from 'lucide-react';

// --- Constants & Data ---
const SUITS = {
  MAN: 'man', // 萬
  PIN: 'pin', // 筒
  SOU: 'sou', // 索
  HONOR: 'honor' // 番子
};

const TILES_DATA = [
  // Man (0-8)
  ...Array.from({ length: 9 }, (_, i) => ({ id: i, type: SUITS.MAN, val: i + 1, label: `${i + 1}萬`, short: `${i + 1}萬` })),
  // Pin (9-17)
  ...Array.from({ length: 9 }, (_, i) => ({ id: i + 9, type: SUITS.PIN, val: i + 1, label: `${i + 1}筒`, short: `${i + 1}筒` })),
  // Sou (18-26)
  ...Array.from({ length: 9 }, (_, i) => ({ id: i + 18, type: SUITS.SOU, val: i + 1, label: `${i + 1}索`, short: `${i + 1}索` })),
  // Honors (27-33)
  { id: 27, type: SUITS.HONOR, val: 1, label: '東', short: '東' },
  { id: 28, type: SUITS.HONOR, val: 2, label: '南', short: '南' },
  { id: 29, type: SUITS.HONOR, val: 3, label: '西', short: '西' },
  { id: 30, type: SUITS.HONOR, val: 4, label: '北', short: '北' },
  { id: 31, type: SUITS.HONOR, val: 5, label: '紅中', short: '中' },
  { id: 32, type: SUITS.HONOR, val: 6, label: '發財', short: '發' },
  { id: 33, type: SUITS.HONOR, val: 7, label: '白板', short: '白' },
];

// --- Algorithm Logic ---

const getTileCounts = (handIds) => {
  const counts = new Array(34).fill(0);
  handIds.forEach(id => {
    if (id >= 0 && id < 34) counts[id]++;
  });
  return counts;
};

const checkSets = (counts) => {
  let i = 0;
  while (i < 34 && counts[i] === 0) i++;
  if (i === 34) return true;

  // Try Triple (刻子)
  if (counts[i] >= 3) {
    counts[i] -= 3;
    if (checkSets(counts)) return true;
    counts[i] += 3;
  }

  // Try Sequence (順子) - Only for non-honor tiles
  if (i < 27 && i % 9 <= 6) {
    if (counts[i + 1] > 0 && counts[i + 2] > 0) {
      counts[i]--;
      counts[i + 1]--;
      counts[i + 2]--;
      if (checkSets(counts)) return true;
      counts[i]++;
      counts[i + 1]++;
      counts[i + 2]++;
    }
  }
  return false;
};

const checkWin = (counts) => {
  for (let i = 0; i < 34; i++) {
    if (counts[i] >= 2) {
      const tempCounts = [...counts];
      tempCounts[i] -= 2;
      if (checkSets(tempCounts)) return true;
    }
  }
  return false;
};

const solveHand = (currentHandIds) => {
  if (currentHandIds.length !== 13) return [];
  const waitingTiles = [];
  const baseCounts = getTileCounts(currentHandIds);

  for (let i = 0; i < 34; i++) {
    if (baseCounts[i] >= 4) continue;
    baseCounts[i]++;
    if (checkWin(baseCounts)) {
      waitingTiles.push(TILES_DATA[i]);
    }
    baseCounts[i]--;
  }
  return waitingTiles;
};

const analyzeDiscards = (handIds) => {
  if (handIds.length !== 14) return [];
  const uniqueTileIds = [...new Set(handIds)];
  const suggestions = [];

  uniqueTileIds.forEach(discardId => {
    const tempHand = [...handIds];
    const idx = tempHand.indexOf(discardId);
    tempHand.splice(idx, 1);
    const waits = solveHand(tempHand);
    if (waits.length > 0) {
      suggestions.push({
        discard: TILES_DATA.find(t => t.id === discardId),
        waiting: waits,
        count: waits.length
      });
    }
  });

  return suggestions.sort((a, b) => b.count - a.count);
};

// --- Renderers ---
const C_RED = "#D32F2F";
const C_GREEN = "#388E3C";
const C_BLUE = "#1976D2";
const C_BLACK = "#212121";

const TileContent = ({ data }) => {
  const chars = ["一", "二", "三", "四", "五", "六", "七", "八", "九"];
  if (data.type === SUITS.HONOR) {
    let char = "";
    let color = C_BLACK;
    switch(data.val) {
        case 1: char = "東"; break;
        case 2: char = "南"; break;
        case 3: char = "西"; break;
        case 4: char = "北"; break;
        case 5: char = "中"; color = C_RED; break;
        case 6: char = "發"; color = C_GREEN; break;
        case 7: return <div className="w-full h-full p-2"><div className="w-full h-full border-2 border-blue-800 rounded-sm"></div></div>;
    }
    return <div className="flex items-center justify-center w-full h-full font-serif font-bold text-lg" style={{ color }}>{char}</div>;
  }

  const suitColor = data.type === SUITS.MAN ? C_RED : data.type === SUITS.PIN ? C_BLUE : C_GREEN;
  const suitChar = data.type === SUITS.MAN ? "萬" : data.type === SUITS.PIN ? "筒" : "索";

  return (
    <div className="flex flex-col items-center justify-center w-full h-full leading-none font-serif">
      <span className="text-xs font-bold" style={{ color: C_BLACK }}>{chars[data.val-1]}</span>
      <span className="text-sm font-bold mt-[-2px]" style={{ color: suitColor }}>{suitChar}</span>
    </div>
  );
};

const Tile = ({ data, onClick, size = "md", className = "", highlight = false, badge = null, disabled = false }) => {
  const sizeClasses = {
    xs: "w-8 h-10",
    sm: "w-10 h-14",
    md: "w-10 h-14 sm:w-12 sm:h-16", 
    lg: "w-16 h-24"
  };

  return (
    <div 
      onClick={() => !disabled && onClick && onClick(data)}
      className={`
        relative group transition-all
        ${sizeClasses[size]} 
        bg-[#FAFAFA] rounded-md shadow-md border border-gray-200 
        ${highlight ? 'ring-2 ring-yellow-400 -translate-y-2 z-10' : 'border-b-[5px] border-b-[#15803d]'}
        ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer active:translate-y-0 hover:-translate-y-1'}
        flex flex-col items-center justify-center select-none ${className}
      `}
    >
      <div className="w-full h-full overflow-hidden rounded-t-md p-0.5">
          <TileContent data={data} />
      </div>
      {badge && (
         <span className="absolute -top-3 -right-1 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full shadow-sm z-20 font-bold border border-white">
            {badge}
         </span>
      )}
    </div>
  );
};

export default function App() {
  const [hand, setHand] = useState([]);
  const [activeTab, setActiveTab] = useState(SUITS.MAN);

  const { waiting, suggestions, isWin } = useMemo(() => {
    const ids = hand.map(t => t.id);
    if (ids.length === 13) {
      return { waiting: solveHand(ids), suggestions: [], isWin: false };
    } else if (ids.length === 14) {
      const win = checkWin(getTileCounts(ids));
      return { waiting: [], suggestions: analyzeDiscards(ids), isWin: win };
    }
    return { waiting: [], suggestions: [], isWin: false };
  }, [hand]);

  const addToHand = (tile) => {
    if (hand.length >= 14) return;
    if (hand.filter(t => t.id === tile.id).length >= 4) return;
    setHand([...hand, tile]);
  };

  const removeFromHand = (index) => {
    setHand(prev => prev.filter((_, i) => i !== index));
  };

  const sortHand = () => setHand(prev => [...prev].sort((a, b) => a.id - b.id));

  return (
    <div className="min-h-screen bg-green-800 text-white flex flex-col font-sans select-none">
      <header className="bg-green-900 p-3 shadow-lg flex justify-between items-center sticky top-0 z-40 border-b border-green-700">
        <div className="flex items-center gap-2">
            <div className="w-8 h-10 bg-white rounded border-b-4 border-b-green-700 flex items-center justify-center">
                <span className="text-green-600 font-bold font-serif text-xl">發</span>
            </div>
            <div>
                <h1 className="text-lg font-bold tracking-wider leading-tight text-white">麻雀叫糊計算機</h1>
                <p className="text-[10px] text-green-300">清一色/多面聽 救星</p>
            </div>
        </div>
        <button onClick={() => setHand([])} className="text-xs bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded flex items-center gap-1 transition shadow-sm active:scale-95">
          <Trash2 size={14} /> 重置
        </button>
      </header>

      <main className="flex-1 flex flex-col items-center p-3 gap-4 max-w-3xl mx-auto w-full">
        {/* Result Area */}
        <div className={`w-full bg-green-700/80 rounded-xl p-4 min-h-[160px] flex flex-col items-center border border-green-500 shadow-xl backdrop-blur-md transition-all ${isWin ? 'ring-4 ring-yellow-400 bg-green-800' : ''}`}>
          {hand.length === 14 ? (
            <div className="w-full space-y-3">
              {isWin && (
                <div className="bg-gradient-to-r from-yellow-600 to-amber-600 p-3 rounded-lg shadow-lg border border-yellow-400 flex items-center justify-center gap-3 mb-2 animate-bounce-short">
                  <Trophy className="text-white" size={24} />
                  <h2 className="text-white font-black text-xl tracking-widest">食糊 / 自摸！</h2>
                  <Trophy className="text-white" size={24} />
                </div>
              )}
              {suggestions.length > 0 ? (
                <div className="space-y-2">
                  <h2 className="text-yellow-300 font-bold text-sm flex items-center gap-2">
                    <Lightbulb size={18} /> {isWin ? '不想食糊？建議打：' : '建議出牌：'}
                  </h2>
                  <div className="max-h-[120px] overflow-y-auto space-y-2 custom-scrollbar pr-1">
                    {suggestions.map((s, i) => (
                      <div key={i} className="bg-green-900/60 p-2 rounded-lg flex items-center gap-3 border border-green-600/30">
                        <Tile data={s.discard} size="xs" disabled />
                        <div className="flex-1">
                          <p className="text-xs font-bold text-white">聽 {s.count} 門：{s.waiting.map(w => w.short).join(' ')}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ) : !isWin && <div className="text-center py-4 text-red-300 font-bold">無叫糊 / 相公</div>}
            </div>
          ) : hand.length === 13 ? (
            <div className="text-center py-4">
              {waiting.length > 0 ? (
                <>
                  <h2 className="text-yellow-300 font-bold text-lg mb-3 flex items-center justify-center gap-2">
                    <CheckCircle2 size={24} /> 叫糊！聽：
                  </h2>
                  <div className="flex flex-wrap justify-center gap-2">
                    {waiting.map((t, idx) => <Tile key={idx} data={t} size="sm" disabled />)}
                  </div>
                </>
              ) : <p className="text-slate-300">未叫糊，請加入第 14 隻牌查看建議</p>}
            </div>
          ) : (
            <div className="text-center py-8 opacity-50">
              <p className="text-green-200">請輸入 13 或 14 隻手牌 ({hand.length}/14)</p>
            </div>
          )}
        </div>

        {/* Hand Display */}
        <div className="w-full">
          <div className="flex justify-between items-center mb-2 px-1">
            <span className="text-xs font-bold text-green-100 uppercase tracking-widest">目前手牌</span>
            <button onClick={sortHand} className="text-xs bg-blue-600 px-3 py-1 rounded-full flex items-center gap-1 shadow-md active:scale-95">
              <ArrowDownUp size={12} /> 理牌
            </button>
          </div>
          <div className="bg-green-900/40 p-3 rounded-xl border border-green-800 min-h-[100px] flex flex-wrap gap-2 justify-center items-center shadow-inner">
            {hand.map((tile, index) => (
              <Tile 
                key={`${tile.id}-${index}`} 
                data={tile} 
                size="sm" 
                onClick={() => removeFromHand(index)}
                highlight={suggestions.length > 0 && suggestions[0].discard.id === tile.id && !isWin}
              />
            ))}
            {Array.from({ length: 14 - hand.length }).map((_, i) => (
              <div key={i} className="w-10 h-14 rounded border-2 border-dashed border-green-700/30 bg-green-900/10" />
            ))}
          </div>
        </div>

        {/* Keyboard Area */}
        <div className="w-full bg-slate-100 rounded-2xl text-slate-900 shadow-2xl overflow-hidden mt-auto">
          <div className="flex bg-slate-200">
            {[[SUITS.MAN,'萬'],[SUITS.PIN,'筒'],[SUITS.SOU,'索'],[SUITS.HONOR,'番']].map(([s,l]) => (
              <button key={s} onClick={() => setActiveTab(s)} className={`flex-1 py-3 text-sm font-bold transition-all ${activeTab === s ? 'bg-white text-green-700 shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>{l}</button>
            ))}
          </div>
          <div className="p-3 grid grid-cols-5 sm:grid-cols-9 gap-2 justify-items-center min-h-[200px] bg-slate-50">
            {TILES_DATA.filter(t => t.type === activeTab).map(tile => {
              const count = hand.filter(t => t.id === tile.id).length;
              return (
                <Tile 
                  key={tile.id} 
                  data={tile} 
                  onClick={addToHand} 
                  size="sm" 
                  disabled={count >= 4 || hand.length >= 14}
                  badge={count > 0 ? count : null}
                />
              );
            })}
          </div>
        </div>
      </main>
    </div>
  );
}