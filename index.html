<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麻雀叫糊計算機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #171717;
            margin: 0;
            overscroll-behavior: none;
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4ade80; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #166534; }
        @keyframes bounce-short {
            0%, 100% { transform: translateY(-3px); }
            50% { transform: translateY(0); }
        }
        .animate-bounce-short { animation: bounce-short 1s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const SUITS = { MAN: 'man', PIN: 'pin', SOU: 'sou', HONOR: 'honor' };

        const TILES_DATA = [
            ...Array.from({ length: 9 }, (_, i) => ({ id: i, type: SUITS.MAN, val: i + 1, short: `${i + 1}萬` })),
            ...Array.from({ length: 9 }, (_, i) => ({ id: i + 9, type: SUITS.PIN, val: i + 1, short: `${i + 1}筒` })),
            ...Array.from({ length: 9 }, (_, i) => ({ id: i + 18, type: SUITS.SOU, val: i + 1, short: `${i + 1}索` })),
            { id: 27, type: SUITS.HONOR, val: 1, short: '東' },
            { id: 28, type: SUITS.HONOR, val: 2, short: '南' },
            { id: 29, type: SUITS.HONOR, val: 3, short: '西' },
            { id: 30, type: SUITS.HONOR, val: 4, short: '北' },
            { id: 31, type: SUITS.HONOR, val: 5, short: '中' },
            { id: 32, type: SUITS.HONOR, val: 6, short: '發' },
            { id: 33, type: SUITS.HONOR, val: 7, short: '白' },
        ];

        // --- 邏輯函數 ---
        const getTileCounts = (handIds) => {
            const counts = new Array(34).fill(0);
            handIds.forEach(id => { if (id >= 0 && id < 34) counts[id]++; });
            return counts;
        };

        const checkSets = (counts) => {
            let i = 0;
            while (i < 34 && counts[i] === 0) i++;
            if (i === 34) return true;
            if (counts[i] >= 3) {
                counts[i] -= 3;
                if (checkSets(counts)) return true;
                counts[i] += 3;
            }
            if (i < 27 && i % 9 <= 6) {
                if (counts[i + 1] > 0 && counts[i + 2] > 0) {
                    counts[i]--; counts[i + 1]--; counts[i + 2]--;
                    if (checkSets(counts)) return true;
                    counts[i]++; counts[i + 1]++; counts[i + 2]++;
                }
            }
            return false;
        };

        const checkWin = (counts) => {
            for (let i = 0; i < 34; i++) {
                if (counts[i] >= 2) {
                    const tempCounts = [...counts];
                    tempCounts[i] -= 2;
                    if (checkSets(tempCounts)) return true;
                }
            }
            return false;
        };

        const solveHand = (currentHandIds) => {
            if (currentHandIds.length !== 13) return [];
            const waitingTiles = [];
            const baseCounts = getTileCounts(currentHandIds);
            for (let i = 0; i < 34; i++) {
                if (baseCounts[i] >= 4) continue;
                baseCounts[i]++;
                if (checkWin(baseCounts)) waitingTiles.push(TILES_DATA[i]);
                baseCounts[i]--;
            }
            return waitingTiles;
        };

        const analyzeDiscards = (handIds) => {
            if (handIds.length !== 14) return [];
            const uniqueTileIds = [...new Set(handIds)];
            const suggestions = [];
            uniqueTileIds.forEach(discardId => {
                const tempHand = [...handIds];
                const idx = tempHand.indexOf(discardId);
                tempHand.splice(idx, 1);
                const waits = solveHand(tempHand);
                if (waits.length > 0) {
                    suggestions.push({
                        discard: TILES_DATA.find(t => t.id === discardId),
                        waiting: waits,
                        count: waits.length
                    });
                }
            });
            return suggestions.sort((a, b) => b.count - a.count);
        };

        // --- 元件 ---
        const TileContent = ({ data }) => {
            const chars = ["一", "二", "三", "四", "五", "六", "七", "八", "九"];
            if (data.type === SUITS.HONOR) {
                let char = ""; let color = "#212121";
                switch(data.val) {
                    case 1: char = "東"; break; case 2: char = "南"; break;
                    case 3: char = "西"; break; case 4: char = "北"; break;
                    case 5: char = "中"; color = "#D32F2F"; break;
                    case 6: char = "發"; color = "#388E3C"; break;
                    case 7: return <div className="w-full h-full p-1.5"><div className="w-full h-full border-[1.5px] border-blue-800 rounded-sm"></div></div>;
                }
                // 番子增加垂直內邊距
                return <div className="flex items-center justify-center w-full h-full font-serif font-bold text-sm py-1" style={{ color }}>{char}</div>;
            }
            const suitColor = data.type === SUITS.MAN ? "#D32F2F" : data.type === SUITS.PIN ? "#1976D2" : "#388E3C";
            const suitChar = data.type === SUITS.MAN ? "萬" : data.type === SUITS.PIN ? "筒" : "索";
            
            // 增加 pt-1.5 和 pb-1 來拉開上下字與字、字與邊緣的間距
            return (
                <div className="flex flex-col items-center justify-between w-full h-full leading-none font-serif pt-1.5 pb-1">
                    <span className="text-[9px] font-bold text-slate-800">{chars[data.val-1]}</span>
                    <span className="text-[10px] font-bold" style={{ color: suitColor }}>{suitChar}</span>
                </div>
            );
        };

        const Tile = ({ data, onClick, size = "md", highlight = false, badge = null, disabled = false }) => {
            // 為了保持一排 9 隻，寬度維持 32px，但高度稍微增加以對應增加的上下間距
            const style = size === "sm" ? { width: '28px', height: '40px' } : 
                         size === "md" ? { width: '32px', height: '48px' } : 
                         size === "xs" ? { width: '24px', height: '32px' } : {};

            return (
                <div onClick={() => !disabled && onClick && onClick(data)} 
                     style={style}
                     className={`relative transition-all bg-[#FAFAFA] rounded-md shadow-sm border border-gray-200 ${highlight ? 'ring-2 ring-yellow-400 -translate-y-1 z-10' : 'border-b-[2px] border-b-green-700'} ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer active:translate-y-0 hover:-translate-y-0.5'} flex flex-col items-center justify-center shrink-0`}>
                    <div className="w-full h-full overflow-hidden p-0.5"><TileContent data={data} /></div>
                    {badge && <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[7px] px-1 py-0.5 rounded-full shadow-sm z-20 font-bold border border-white leading-none">{badge}</span>}
                </div>
            );
        };

        function App() {
            const [hand, setHand] = useState([]);
            const [activeTab, setActiveTab] = useState(SUITS.MAN);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [activeTab, hand]);

            const { waiting, suggestions, isWin } = useMemo(() => {
                const ids = hand.map(t => t.id);
                if (ids.length === 13) return { waiting: solveHand(ids), suggestions: [], isWin: false };
                if (ids.length === 14) return { waiting: [], suggestions: analyzeDiscards(ids), isWin: checkWin(getTileCounts(ids)) };
                return { waiting: [], suggestions: [], isWin: false };
            }, [hand]);

            return (
                <div className="min-h-screen bg-neutral-900 flex justify-center">
                    <div className="w-full max-w-md bg-green-800 flex flex-col shadow-2xl relative">
                        <header className="bg-green-900 p-3 shadow-lg flex justify-between items-center sticky top-0 z-40 border-b border-green-700">
                            <div className="flex items-center gap-2">
                                <div className="w-6 h-8 bg-white rounded border-b-2 border-b-green-700 flex items-center justify-center"><span className="text-green-600 font-bold text-base">發</span></div>
                                <div><h1 className="text-xs font-bold text-white tracking-wide">麻雀叫糊助手</h1><p className="text-[8px] text-green-300 italic">Vercel Pro</p></div>
                            </div>
                            <button onClick={() => setHand([])} className="text-[10px] bg-red-600 px-3 py-1.5 rounded-full flex items-center gap-1 active:scale-95 text-white font-bold"><i data-lucide="trash-2" className="w-3 h-3"></i> 清除</button>
                        </header>

                        <main className="flex-1 flex flex-col p-3 gap-4 overflow-y-auto overflow-x-hidden">
                            <div className={`w-full bg-green-700/80 rounded-xl p-3 min-h-[110px] flex flex-col items-center border border-green-500 shadow-lg backdrop-blur-sm transition-all ${isWin ? 'ring-2 ring-yellow-400 bg-green-800' : ''}`}>
                                {hand.length === 14 ? (
                                    <div className="w-full space-y-2">
                                        {isWin && (
                                            <div className="bg-gradient-to-r from-yellow-600 to-amber-600 p-1.5 rounded-lg shadow-md border border-yellow-400 flex items-center justify-center gap-2 animate-bounce-short mb-1">
                                                <i data-lucide="trophy" className="text-white w-4 h-4"></i>
                                                <h2 className="text-white font-black text-sm tracking-widest">食糊！</h2>
                                            </div>
                                        )}
                                        {suggestions.length > 0 ? (
                                            <div className="space-y-1.5">
                                                <h2 className="text-yellow-300 font-bold text-[10px] flex items-center gap-1.5"><i data-lucide="lightbulb" className="w-3.5 h-3.5"></i> {isWin ? '建議捨牌：' : '聽牌建議：'}</h2>
                                                <div className="max-h-[100px] overflow-y-auto space-y-1.5 custom-scrollbar pr-1">
                                                    {suggestions.map((s, i) => (
                                                        <div key={i} className="bg-green-900/60 p-1.5 rounded-lg flex items-center gap-3 border border-green-600/30">
                                                            <Tile data={s.discard} size="xs" disabled />
                                                            <p className="text-[10px] font-bold text-white">聽 {s.count} 門：<span className="text-yellow-400">{s.waiting.map(w => w.short).join(' ')}</span></p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : !isWin && <div className="text-center py-4 text-red-300 font-bold text-[10px] italic">相公或未叫糊</div>}
                                    </div>
                                ) : hand.length === 13 ? (
                                    <div className="text-center py-1">
                                        {waiting.length > 0 ? (
                                            <>
                                                <h2 className="text-yellow-300 font-bold text-xs mb-2 flex items-center justify-center gap-1.5"><i data-lucide="check-circle-2" className="w-4 h-4"></i> 叫糊中！</h2>
                                                <div className="flex flex-wrap justify-center gap-1">{waiting.map((t, idx) => <Tile key={idx} data={t} size="sm" disabled />)}</div>
                                            </>
                                        ) : <p className="text-green-200/50 text-[10px] py-4 italic tracking-wide">未入聽，請加入第14隻牌</p>}
                                    </div>
                                ) : (
                                    <div className="text-center py-8 opacity-40"><p className="text-green-200 text-[10px] tracking-widest font-bold">請輸入手牌 ({hand.length}/14)</p></div>
                                )}
                            </div>

                            <div className="w-full">
                                <div className="flex justify-between items-center mb-1.5 px-1">
                                    <span className="text-[9px] font-bold text-green-100 uppercase tracking-widest opacity-60">目前手牌</span>
                                    <button onClick={() => setHand([...hand].sort((a, b) => a.id - b.id))} className="text-[9px] bg-blue-600 px-3 py-1 rounded-full text-white font-bold active:scale-95 shadow-sm">自動理牌</button>
                                </div>
                                <div className="bg-green-900/40 p-2.5 rounded-xl border border-green-800 min-h-[90px] flex flex-wrap gap-1 justify-center items-center shadow-inner">
                                    {hand.map((tile, index) => <Tile key={index} data={tile} size="sm" onClick={() => setHand(hand.filter((_, i) => i !== index))} />)}
                                    {Array.from({ length: Math.max(0, 14 - hand.length) }).map((_, i) => <div key={i} className="w-[28px] h-[40px] rounded border border-dashed border-green-700/30 bg-green-900/5" />)}
                                </div>
                            </div>

                            <div className="mt-auto -mx-3 bg-slate-100 rounded-t-[2rem] text-slate-900 shadow-2xl pt-1 border-t border-white/20">
                                <div className="flex px-3 gap-0.5">
                                    {[[SUITS.MAN,'萬'],[SUITS.PIN,'筒'],[SUITS.SOU,'索'],[SUITS.HONOR,'番']].map(([s,l]) => (
                                        <button key={s} onClick={() => setActiveTab(s)} className={`flex-1 py-2.5 text-[11px] font-bold transition-all rounded-t-xl ${activeTab === s ? 'bg-slate-50 text-green-700 shadow-sm' : 'text-slate-400'}`}>{l}</button>
                                    ))}
                                </div>
                                <div className="p-3 min-h-[160px] bg-slate-50">
                                    <div className="flex justify-between items-center px-0.5 py-4 gap-[0.65rem]">
                                        {TILES_DATA.filter(t => t.type === activeTab).map(tile => {
                                            const count = hand.filter(t => t.id === tile.id).length;
                                            return <Tile key={tile.id} data={tile} size="md" onClick={t => hand.length < 14 && count < 4 && setHand([...hand, t])} disabled={count >= 4 || hand.length >= 14} badge={count > 0 ? count : null} />;
                                        })}
                                    </div>
                                </div>
                                <div className="h-4 bg-slate-50"></div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>