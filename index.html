<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å»£æ±éº»é›€å«ç³ŠåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #064e3b; 
            overscroll-behavior: none;
            color: white;
            margin: 0;
        }
        .tile-shadow { box-shadow: 0 4px 0 #d1d5db; }
        .active-tile-shadow { box-shadow: 0 2px 0 #9ca3af; transform: translateY(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.2s ease-out forwards; }
        /* é˜²æ­¢é¸å–æ–‡å­— */
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        const SUITS = { MAN: 'man', PIN: 'pin', SOU: 'sou', HONOR: 'honor' };
        const COLORS = { red: "#e11d48", blue: "#1d4ed8", green: "#059669", black: "#1f2937" };

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå»£æ±éº»é›€ 4é¢å­ + 1å°çœ¼ ---
        const canFormSets = (counts) => {
            let i = 0;
            while (i < 34 && counts[i] === 0) i++;
            if (i === 34) return true;

            // åˆ»å­ (AAA)
            if (counts[i] >= 3) {
                counts[i] -= 3;
                if (canFormSets(counts)) return true;
                counts[i] += 3;
            }

            // é †å­ (ABC) - åªæœ‰æ•¸ç‰Œ (i < 27) æœ‰é †å­
            if (i < 27 && i % 9 <= 6) {
                if (counts[i+1] > 0 && counts[i+2] > 0) {
                    counts[i]--; counts[i+1]--; counts[i+2]--;
                    if (canFormSets(counts)) return true;
                    counts[i]++; counts[i+1]++; counts[i+2]++;
                }
            }
            return false;
        };

        const isWinningHand = (handIds) => {
            if (handIds.length !== 14) return false;
            const counts = new Array(34).fill(0);
            handIds.forEach(id => counts[id]++);
            for (let i = 0; i < 34; i++) {
                if (counts[i] >= 2) {
                    const temp = [...counts];
                    temp[i] -= 2; // å˜—è©¦é€™å°ç‰Œä½œç‚ºã€Œçœ¼ã€
                    if (canFormSets(temp)) return true;
                }
            }
            return false;
        };

        const getWaitTiles = (handIds) => {
            if (handIds.length !== 13) return [];
            const results = [];
            const counts = new Array(34).fill(0);
            handIds.forEach(id => counts[id]++);
            for (let i = 0; i < 34; i++) {
                if (counts[i] >= 4) continue;
                const testHand = [...handIds, i];
                if (isWinningHand(testHand)) results.push(i);
            }
            return results;
        };

        // --- ç‰Œé¢æ•¸æ“š ---
        const TILES_DATA = [
            ...Array.from({length: 9}, (_, i) => ({ id: i, type: SUITS.MAN, val: i + 1, text: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"][i] })),
            ...Array.from({length: 9}, (_, i) => ({ id: i + 9, type: SUITS.PIN, val: i + 1 })),
            ...Array.from({length: 9}, (_, i) => ({ id: i + 18, type: SUITS.SOU, val: i + 1 })),
            { id: 27, type: SUITS.HONOR, val: 1, text: 'æ±' },
            { id: 28, type: SUITS.HONOR, val: 2, text: 'å—' },
            { id: 29, type: SUITS.HONOR, val: 3, text: 'è¥¿' },
            { id: 30, type: SUITS.HONOR, val: 4, text: 'åŒ—' },
            { id: 31, type: SUITS.HONOR, val: 5, text: 'ä¸­' },
            { id: 32, type: SUITS.HONOR, val: 6, text: 'ç™¼' },
            { id: 33, type: SUITS.HONOR, val: 7, text: 'ç™½' },
        ];

        // --- UI å…ƒä»¶ ---
        const Tile = ({ tile, onClick, badge, size = "md", highlight = false, disabled = false }) => {
            if (!tile) return null;
            const isSmall = size === "sm";
            const baseClass = `relative bg-white text-black rounded flex items-center justify-center transition-all tile-shadow border border-gray-200 ${disabled ? 'opacity-40' : 'active:active-tile-shadow active:scale-95 cursor-pointer'}`;
            const sizeClass = isSmall ? "w-8 h-11 text-sm" : "w-10 h-14 text-lg";
            const highlightClass = highlight ? "ring-4 ring-yellow-400 -translate-y-2" : "";

            const renderIcon = () => {
                if (tile.type === SUITS.MAN) {
                    return <div className="flex flex-col items-center leading-none">
                        <span className="text-[10px] font-bold">{tile.text}</span>
                        <span className="text-xs font-bold text-red-600">è¬</span>
                    </div>;
                }
                if (tile.type === SUITS.PIN) {
                    return <div className={`grid ${tile.val === 1 ? 'grid-cols-1' : 'grid-cols-2'} gap-0.5 p-1`}>
                        {Array.from({length: tile.val}).map((_, i) => (
                            <div key={i} className={`rounded-full ${tile.val === 1 ? 'w-5 h-5 border-4 border-red-500' : 'w-2 h-2 bg-blue-700'}`} />
                        ))}
                    </div>;
                }
                if (tile.type === SUITS.SOU) {
                    return <div className="flex flex-col gap-0.5">
                        <div className="w-1.5 h-4 bg-green-700 rounded-sm" />
                        {tile.val > 1 && <div className="w-1.5 h-4 bg-green-700 rounded-sm" />}
                    </div>;
                }
                const color = tile.val === 5 ? COLORS.red : tile.val === 6 ? COLORS.green : COLORS.blue;
                return <span className="font-bold text-xl" style={{color}}>{tile.text}</span>;
            };

            return (
                <div onClick={() => !disabled && onClick && onClick(tile)} className={`${baseClass} ${sizeClass} ${highlightClass}`}>
                    {renderIcon()}
                    {badge > 0 && (
                        <div className="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center border border-white font-bold">
                            {badge}
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [hand, setHand] = useState([]);
            const [activeTab, setActiveTab] = useState(SUITS.MAN);

            const analysis = useMemo(() => {
                const ids = hand.map(t => t.id);
                if (ids.length === 13) return { type: 'waiting', data: getWaitTiles(ids).map(id => TILES_DATA[id]) };
                if (ids.length === 14) {
                    if (isWinningHand(ids)) return { type: 'win' };
                    const suggestions = [...new Set(ids)].map(id => {
                        const temp = [...ids];
                        temp.splice(temp.indexOf(id), 1);
                        const waits = getWaitTiles(temp);
                        return { discard: TILES_DATA[id], waits, count: waits.length };
                    }).filter(s => s.count > 0).sort((a,b) => b.count - a.count);
                    return { type: 'suggestions', data: suggestions };
                }
                return { type: 'none' };
            }, [hand]);

            const addTile = (t) => {
                if (hand.length < 14 && hand.filter(x => x.id === t.id).length < 4) {
                    setHand([...hand, t]);
                }
            };
            const removeTile = (i) => {
                const n = [...hand]; n.splice(i, 1); setHand(n);
            };
            const sortHand = () => setHand([...hand].sort((a,b) => a.id - b.id));

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-[#043d2f] shadow-2xl relative">
                    <header className="p-4 bg-green-900 flex justify-between items-center border-b border-green-700">
                        <h1 className="font-bold text-lg">å»£æ±éº»é›€åŠ©æ‰‹</h1>
                        <button onClick={() => setHand([])} className="text-xs bg-red-700 px-3 py-1 rounded-full">æ¸…ç©º</button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 space-y-4 pb-64 no-scrollbar">
                        <div className="bg-black/20 rounded-2xl p-4 min-h-[120px] flex flex-col justify-center border border-white/5">
                            {analysis.type === 'win' && <div className="text-center text-yellow-400 font-bold text-xl animate-fade">é£Ÿç³Šäº†ï¼ğŸ‰</div>}
                            {analysis.type === 'waiting' && (
                                <div className="text-center animate-fade">
                                    <p className="text-[10px] text-green-400 mb-2">è½ç‰Œï¼š</p>
                                    <div className="flex flex-wrap justify-center gap-2">
                                        {analysis.data.length > 0 ? analysis.data.map(t => <Tile key={t.id} tile={t} size="sm" disabled />) : "å°šæœªè½ç‰Œ"}
                                    </div>
                                </div>
                            )}
                            {analysis.type === 'suggestions' && (
                                <div className="space-y-2 animate-fade">
                                    <p className="text-[10px] text-yellow-500">å»ºè­°æ‰“æ³•ï¼š</p>
                                    {analysis.data.slice(0, 2).map((s, i) => (
                                        <div key={i} className="flex items-center gap-3 bg-white/5 p-2 rounded-lg border border-white/5">
                                            <Tile tile={s.discard} size="sm" disabled />
                                            <div className="text-xs">
                                                æ‰“å‡ºæ­¤å¼µï¼Œè½ {s.count} é–€ç‰Œ
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {analysis.type === 'none' && <div className="text-center text-gray-500 text-sm">è«‹é¸æ“‡ 13 æˆ– 14 å¼µç‰Œ<br/>({hand.length}/14)</div>}
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-2 px-1">
                                <span className="text-xs text-green-400">ç›®å‰æ‰‹ç‰Œ ({hand.length})</span>
                                <button onClick={sortHand} className="text-xs bg-blue-700 px-3 py-1 rounded-full">ç†ç‰Œ</button>
                            </div>
                            <div className="flex flex-wrap gap-2 justify-center bg-black/30 p-4 rounded-2xl min-h-[150px] border border-white/5">
                                {hand.map((t, i) => (
                                    <Tile key={i} tile={t} onClick={() => removeTile(i)} 
                                        highlight={analysis.type === 'suggestions' && analysis.data[0]?.discard.id === t.id} />
                                ))}
                            </div>
                        </div>
                    </main>

                    <footer className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-gray-100 rounded-t-3xl shadow-2xl p-2">
                        <div className="flex gap-1 mb-2">
                            {[[SUITS.MAN, 'è¬'], [SUITS.PIN, 'ç­’'], [SUITS.SOU, 'ç´¢'], [SUITS.HONOR, 'ç•ª']].map(([s, l]) => (
                                <button key={s} onClick={() => setActiveTab(s)} className={`flex-1 py-2 text-xs font-bold rounded-xl ${activeTab === s ? 'bg-green-800 text-white' : 'text-gray-500'}`}>{l}</button>
                            ))}
                        </div>
                        <div className="flex gap-2 overflow-x-auto p-2 bg-white rounded-xl no-scrollbar">
                            {TILES_DATA.filter(t => t.type === activeTab).map(t => (
                                <Tile key={t.id} tile={t} size="sm" onClick={addTile} badge={hand.filter(x => x.id === t.id).length} disabled={hand.length >= 14 || hand.filter(x => x.id === t.id).length >= 4} />
                            ))}
                        </div>
                        <div className="h-4"></div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>